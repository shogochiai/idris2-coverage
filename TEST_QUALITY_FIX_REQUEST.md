# idris2-coverage テスト品質改善依頼書

## 問題概要

STPM分析の結果、本プロジェクトのテストの**約70%が低品質**(スコア < 0.5)と判定されました。

- 総テスト数: 96
- 平均スコア: **0.346** (目標: 0.8以上)
- 低スコア数: 67
- 高スコア数: 12

## 問題パターン

### パターン1: 仕様と異なる観点でのテスト

**REQ_COV_COL_002** (スコア: 0.2)
```
Spec: Collector SHALL extract function name and hit count from each row
Test: let defs = parseSchemeDefs "..." ; pure $ length defs >= 1
```

**問題点:** 仕様は「関数名とヒット数の抽出」だが、テストは「パース結果が1件以上」しか確認していない。

**修正後:**
```idris
test_COL_002 = do
  let html = "<table><tr><td>Main.add</td><td>42</td></tr></table>"
  let hits = parseProfileHtml html
  case hits of
    [h] => pure (h.funcName == "Main.add" && h.hitCount == 42)
    _   => pure False
```

### パターン2: 仕様の一部のみ検証

**REQ_COV_SRC_002** (スコア: 0.1)
```
Spec: SourceAnalyzer SHALL determine line_start and line_end for each function
Test: pure $ length exports >= 1
```

**問題点:** line_start/line_endの検証が全くない。

**修正後:**
```idris
test_SRC_002 = do
  let source = "module Test\n\nadd : Int -> Int\nadd x = x + 1"
  let funcs = analyzeSource source
  case funcs of
    [f] => pure (f.lineStart == 3 && f.lineEnd == 4)
    _   => pure False
```

### パターン3: 常にTrueを返すテスト

**REQ_COV_COL_004** (スコア: 0.25)
```idris
test_COL_004 = do
  let hits = parseProfileHtml html
  pure $ True  -- Zero coverage is valid
```

**問題点:** 何も検証していない。

## 修正が必要なテスト一覧

| REQ_ID | 現スコア | 問題 |
|--------|----------|------|
| REQ_COV_SRC_002 | 0.10 | line_start/end未検証 |
| REQ_COV_COL_002 | 0.20 | 関数名/ヒット数未検証 |
| REQ_COV_COL_004 | 0.25 | 常にTrue |
| REQ_COV_SRC_003 | 0.20 | export visibility未検証 |
| REQ_COV_LIN_* | 0.20-0.30 | 行番号マッピング未検証 |

## 修正方針

1. **仕様の各項目を個別に検証する**
   - "SHALL extract X and Y" → XとY両方をassert

2. **具体的な期待値を使う**
   - `length >= 1` ではなく `== expected_value`

3. **エッジケースもテスト**
   - 空入力、不正フォーマット、境界値

## 目標

- 全テストのスコアを **0.8以上** に引き上げ
- 仕様の全項目をテストで検証

---
Generated by STPM Analysis Pipeline (2024-12-27)
