name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Chez Scheme (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme

      - name: Install Chez Scheme (macOS)
        if: runner.os == 'macOS'
        run: brew install chezscheme

      - name: Install pack (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "chezscheme" | bash -c "$(curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash)"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install pack (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "chez" | bash -c "$(curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash)"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check versions
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2 --version
          echo "Chez Scheme:"
          chezscheme --version 2>/dev/null || chez --version 2>/dev/null || scheme --version 2>/dev/null || true

      - name: Build
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pack build idris2-coverage.ipkg

      - name: Test (smoke test)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          ./build/exec/idris2-cov --help || true
          echo "Build successful - full test requires compatible Chez Scheme version"
